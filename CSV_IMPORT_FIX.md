# CSV Import Fix Guide  
_Bible Character Chat – July 2025_

---

## 1 ▪ What Was Wrong & How It Was Fixed
**Symptom**  
• Images, timelines and other “Insights” fields were blank or shifted into the wrong columns after a bulk upload.  
• Avatar/feature URLs sometimes ended up in the wrong DB field.

**Root-Cause**  
`characterRepository.bulkCreateCharacters()` used an outdated `knownFields` whitelist.  
Columns such as `timeline_period`, `historical_context`, `geographic_location`, etc. were silently stripped before the row was inserted/updated.

**Patch** (`src/repositories/characterRepository.js`)  
The whitelist now includes every column that exists in `characters`:

```
name, description, persona_prompt, opening_line,
avatar_url, feature_image_url, testament, is_visible,
bible_book,
timeline_period, historical_context, geographic_location,
key_scripture_references, theological_significance,
relationships, study_questions, scriptural_context,
key_events, character_traits
```

_No change is needed in the Admin UI; it already parsed the full CSV._

### NEW ⚙️  Robust CSV Parser
While investigating we also found the **Admin-panel CSV parser** was doing a naïve
`split(',')`, so any cell that itself contained commas or line-breaks caused the
entire row to “shift” – avatar URLs landed in the wrong column and images
therefore failed to load.

We introduced a dedicated utility **`src/utils/csvParser.js`** which now:

• Respects quoted fields that contain commas  
• Handles escaped quotes (`""`) inside quoted fields  
• Preserves new-lines inside a quoted cell (multi-line prompts / questions)  

`AdminPage.js` now imports `parseCSV()` from that helper, eliminating column
shifts and restoring images/timeline data even for complex rows.

---

## 2 ▪ Column Reference & Field Mappings

| CSV Header (modern)        | DB Column | Shown in UI                                      | Legacy Header (still accepted) |
|----------------------------|-----------|--------------------------------------------------|--------------------------------|
| `name` ✅                  | name      | Card title, chat header                          | `character_name` |
| `description` ✅           | description | Card subtitle                                    | — |
| `persona_prompt` ✅        | persona_prompt | Prompt sent to GPT / mock engine              | — |
| `opening_line`             | opening_line | Greeting button                                  | `opening_sentence` |
| `avatar_url`               | avatar_url | Avatar circle                                    | — |
| `feature_image_url`        | feature_image_url | (future hero image)                            | — |
| `testament` ✅ (`old`/`new`)| testament | Filter tags                                      | — |
| `is_visible` ✅ (`true/false`)| is_visible | Whether character appears publicly           | — |
| `bible_book`               | bible_book | Card & Insights                                  | — |
| `timeline_period`          | timeline_period | Insights → Historical Context                   | — |
| `historical_context`       | historical_context | Insights panel                                  | — |
| `geographic_location`      | geographic_location | Insights panel                                  | — |
| `key_scripture_references` | key_scripture_references | Clickable links in Insights                | — |
| `theological_significance` | theological_significance | Insights                                         | — |
| `relationships` (JSON)     | relationships | Insights → Relationships chips                   | — |
| `study_questions`          | study_questions | Insights → Study Questions                       | — |
| `scriptural_context`       | scriptural_context | *Optional* – hidden until future UI             | — |
| *(system columns)*         | id, created_at, updated_at | generated by DB – omit from CSV | — |

---

## 3 ▪ How to Format Your CSV

1. **Header Row must match** the names above (case-sensitive).  
   • Legacy headers are accepted but discouraged.  
2. **Encoding:** UTF-8.  
3. **Quote cells** that contain commas, quotes _or_ line-breaks:  
   `"..., said \"Let my people go\", ..."`  
4. **Boolean fields:** `true` / `false` (lower-case).  
5. **JSON field (`relationships`)** must be valid JSON _inside_ the cell:  

```
"{\"family\":[\"Aaron\",\"Miriam\"],\"opponents\":[\"Pharaoh\"]}"
```  

6. **Line breaks** inside a cell → wrap the whole cell in quotes (`"`).  
7. **Max file size:** ≈ 2 MB (~2 000 rows). Larger? split the file.

### Minimal Example

```
name,description,persona_prompt,testament,is_visible
Moses,"Prophet who led Israel out of Egypt","I am Moses, servant of the Lord.",old,true
```

### Full Example (row-wrapped)

```
name,description,persona_prompt,opening_line,avatar_url,feature_image_url,is_visible,testament,bible_book,timeline_period,historical_context,geographic_location,key_scripture_references,theological_significance,relationships,study_questions
Elijah,"Prophet of fire","I am Elijah...","As the Lord lives",https://img/ava.jpg,https://img/hero.jpg,true,old,"1 Kings","9th c. BCE","Served under Ahab","Israel, Mt Carmel","1 Ki 18:36-39","Prophetic courage","{""opponents"":[""Ahab"",""Jezebel""]}","How does faith fuel courage?\nWhy the still small voice?"
```

### Complex Example (commas, quotes, new-lines)

See **`test_comma_quotes.csv`** in the repo – it demonstrates:
* Commas inside quoted cells (`"Abraham, Father of Nations"`)
* Escaped quotes (`""If I perish, I perish""`)
* Multi-line persona prompt cells

Import this file to verify the new parser and ensure images/fields align.

---

## 4 ▪ Testing Your Import

### A. Via Admin UI (recommended)
1. `./run-app.sh` → open `http://localhost:5186`  
2. Admin Panel → “Bulk Upload Characters (CSV)”  
3. Choose your file → Upload.  
4. Watch toast / console for success or row-level errors.  
5. Open the Character page → verify Insights sections.

### B. CLI Validation Scripts
| Script | Purpose |
|--------|---------|
| `node csv_column_analysis.js` | Compare any CSV’s headers to DB schema, list mismatches |
| `node test_csv_import.js` | Parses a CSV, upserts rows, then re-queries DB to assert **all fields match** |
| `node check_characters.js` | Lists DB characters, visibility, missing images |

---

## 5 ▪ Common Problems & Fixes

| Problem / Error | Likely Cause | Fix |
|-----------------|--------------|-----|
| “Invalid header” toast | Header names typo / casing | Copy headers from this guide |
| Rows skipped silently | Required field blank (`name`, `persona_prompt`, etc.) | Fill blanks or delete row |
| Images not showing | URL not HTTPS or not square / 16:9 | Use public HTTPS images ≤ 500 kB |
| Relationships panel empty | Malformed JSON | Validate with JSONLint; ensure quotes |
| `42501 new row violates row-level security` | Supabase RLS tightened | Add correct role, or import while logged in as admin |
| Avatar shows colored initials | Image 404 | Open URL in browser; replace |
| Columns shifted | Extra comma inside a cell without quotes | Wrap cell in `"..."` |
| Upload spinner never ends | File > 2 MB or network drop | Split CSV; retry |
| Timeline/Historical fields blank after import | Using legacy headers | Rename to modern headers (see table above) |

---

**Need help?**  
• Re-run `csv_column_analysis.js` for immediate header diagnostics.  
• Check browser console – Admin panel prints detailed row errors.  
• Slack #bible-character-chat or open a GitHub issue with your CSV attached.

Happy importing! 🎉
