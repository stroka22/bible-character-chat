name: Apply Supabase Migrations

on:
  push:
    branches: [ main ]
    paths:
      - 'supabase/migrations/**'
  workflow_dispatch:

jobs:
  supabase-migrate:
    runs-on: ubuntu-latest
    environment: Production
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Validate secrets present (soft)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          missing=0
          if [ -z "${SUPABASE_ACCESS_TOKEN:-}" ]; then echo "[skip] Missing SUPABASE_ACCESS_TOKEN"; missing=1; fi
          if [ -z "${SUPABASE_PROJECT_ID:-}" ] && [ -z "${SUPABASE_PROJECT_REF:-}" ]; then echo "[skip] Missing SUPABASE_PROJECT_ID or SUPABASE_PROJECT_REF"; missing=1; fi
          if [ "$missing" -eq 1 ]; then echo "Supabase secrets not configured. Skipping migration push."; echo "skip" > .skip_migrations; fi

      - name: Login to Supabase
        if: ${{ !(hashFiles('.skip_migrations') != '') }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          supabase login --token "$SUPABASE_ACCESS_TOKEN"

      - name: Link project
        if: ${{ !(hashFiles('.skip_migrations') != '') }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          PROJECT_REF="${SUPABASE_PROJECT_ID:-${SUPABASE_PROJECT_REF}}"
          supabase link --project-ref "$PROJECT_REF"

      - name: Push migrations
        if: ${{ !(hashFiles('.skip_migrations') != '') }}
        run: |
          supabase db push --include-all

      - name: No-op (secrets missing)
        if: ${{ hashFiles('.skip_migrations') != '' }}
        run: |
          echo "Supabase secrets missing â€“ skipping migration push."
