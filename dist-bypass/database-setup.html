<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bible Character Chat - Database Setup</title>
  <!-- Load Supabase directly from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #3b82f6;
      --primary-dark: #2563eb;
      --secondary-color: #f59e0b;
      --text-color: #1e293b;
      --bg-color: #f8fafc;
      --card-bg: #ffffff;
      --success-color: #10b981;
      --error-color: #ef4444;
      --warning-color: #f59e0b;
      --info-color: #3b82f6;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
      color: var(--text-color);
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    
    h1, h2, h3 {
      font-family: 'Cinzel', serif;
      color: #ffffff;
    }
    
    h1 {
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 1rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .subtitle {
      text-align: center;
      color: #e2e8f0;
      margin-bottom: 2rem;
    }
    
    .card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
      padding: 20px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    
    .message {
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 12px;
    }
    
    .success {
      background-color: rgba(16, 185, 129, 0.1);
      color: var(--success-color);
      border-left: 4px solid var(--success-color);
    }
    
    .error {
      background-color: rgba(239, 68, 68, 0.1);
      color: var(--error-color);
      border-left: 4px solid var(--error-color);
    }
    
    .warning {
      background-color: rgba(245, 158, 11, 0.1);
      color: var(--warning-color);
      border-left: 4px solid var(--warning-color);
    }
    
    .info {
      background-color: rgba(59, 130, 246, 0.1);
      color: var(--info-color);
      border-left: 4px solid var(--info-color);
    }
    
    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      margin-right: 10px;
      transition: background-color 0.2s;
    }
    
    button:hover {
      background-color: var(--primary-dark);
    }
    
    button:disabled {
      background-color: #94a3b8;
      cursor: not-allowed;
    }
    
    button.secondary {
      background-color: var(--secondary-color);
    }
    
    button.secondary:hover {
      background-color: #d97706;
    }
    
    button.danger {
      background-color: var(--error-color);
    }
    
    button.danger:hover {
      background-color: #dc2626;
    }
    
    input, select, textarea {
      padding: 10px;
      border: 1px solid #cbd5e0;
      border-radius: 4px;
      width: 100%;
      margin-bottom: 15px;
      font-size: 16px;
    }
    
    textarea {
      min-height: 100px;
      font-family: monospace;
      font-size: 14px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #4b5563;
    }
    
    pre {
      background-color: #f1f5f9;
      padding: 12px;
      border-radius: 4px;
      overflow-x: auto;
      font-family: monospace;
      font-size: 13px;
      line-height: 1.5;
      max-height: 300px;
      overflow-y: auto;
    }
    
    code {
      font-family: monospace;
      background-color: #f1f5f9;
      padding: 2px 4px;
      border-radius: 2px;
      font-size: 14px;
    }
    
    .tabs {
      display: flex;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 8px 8px 0 0;
      overflow: hidden;
      margin-bottom: 0;
    }
    
    .tab {
      padding: 12px 20px;
      cursor: pointer;
      color: #e2e8f0;
      font-weight: 500;
      transition: background-color 0.2s;
      flex: 1;
      text-align: center;
    }
    
    .tab:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    .tab.active {
      background-color: var(--card-bg);
      color: var(--primary-color);
      font-weight: 600;
    }
    
    .tab-content {
      display: none;
      border-radius: 0 0 8px 8px;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid var(--primary-color);
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none;
    }
    
    .flex {
      display: flex;
    }
    
    .flex-col {
      flex-direction: column;
    }
    
    .items-center {
      align-items: center;
    }
    
    .justify-between {
      justify-content: space-between;
    }
    
    .mb-4 {
      margin-bottom: 16px;
    }
    
    .mt-4 {
      margin-top: 16px;
    }
    
    .text-sm {
      font-size: 14px;
    }
    
    .text-xs {
      font-size: 12px;
    }
    
    .text-gray {
      color: #6b7280;
    }
    
    .step-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      background-color: var(--primary-color);
      color: white;
      border-radius: 50%;
      font-weight: 600;
      margin-right: 8px;
    }
    
    .step-title {
      font-weight: 600;
      font-size: 18px;
      color: var(--primary-dark);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
    }
    
    .step-description {
      margin-bottom: 15px;
      color: #4b5563;
    }
    
    .step-content {
      margin-left: 32px;
    }
    
    .step {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .step:last-child {
      border-bottom: none;
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }
    
    .status-pending {
      background-color: #94a3b8;
    }
    
    .status-running {
      background-color: #f59e0b;
      animation: pulse 1.5s infinite;
    }
    
    .status-success {
      background-color: #10b981;
    }
    
    .status-error {
      background-color: #ef4444;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .checkbox-container {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .checkbox-container input[type="checkbox"] {
      width: auto;
      margin-right: 10px;
      margin-bottom: 0;
    }
    
    .sql-preview {
      background-color: #1e293b;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
      margin-bottom: 15px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .nav-links {
      margin-top: 20px;
      text-align: center;
    }
    
    .nav-link {
      display: inline-block;
      background-color: rgba(255, 255, 255, 0.1);
      padding: 10px 15px;
      border-radius: 4px;
      color: white;
      text-decoration: none;
      margin: 0 5px;
      transition: background-color 0.2s;
    }
    
    .nav-link:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Bible Character Chat</h1>
    <p class="subtitle">Database Setup & Repair Tool</p>
    
    <div class="tabs">
      <div class="tab active" data-tab="setup">Database Setup</div>
      <div class="tab" data-tab="users">Test Users</div>
      <div class="tab" data-tab="characters">Sample Characters</div>
      <div class="tab" data-tab="debug">Debug</div>
    </div>
    
    <div class="tab-content card active" id="setup">
      <h2>Database Setup</h2>
      <div id="setup-messages"></div>
      
      <div class="step">
        <div class="step-title"><span class="step-number">1</span> Authentication Status</div>
        <div class="step-description">First, check if you're authenticated with admin privileges.</div>
        <div class="step-content">
          <div id="auth-status" class="message info">
            Checking authentication status...
          </div>
          <div class="actions">
            <button id="check-auth">Check Authentication</button>
            <button id="login-button" class="secondary">Login</button>
          </div>
        </div>
      </div>
      
      <div class="step">
        <div class="step-title"><span class="step-number">2</span> Fix Profiles Table & RLS Policies</div>
        <div class="step-description">Fix the profiles table and its RLS policies to prevent recursion issues.</div>
        <div class="step-content">
          <div class="checkbox-container">
            <input type="checkbox" id="show-profiles-sql" checked>
            <label for="show-profiles-sql">Show SQL Preview</label>
          </div>
          
          <div id="profiles-sql-preview" class="sql-preview">
-- Create profiles table if it doesn't exist
CREATE TABLE IF NOT EXISTS public.profiles (
  id UUID REFERENCES auth.users(id) PRIMARY KEY,
  email TEXT,
  first_name TEXT,
  last_name TEXT,
  role TEXT DEFAULT 'user',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- Drop existing RLS policies to avoid conflicts
DROP POLICY IF EXISTS "Users can view their own profile" ON public.profiles;
DROP POLICY IF EXISTS "Users can update their own profile" ON public.profiles;
DROP POLICY IF EXISTS "Admins can view all profiles" ON public.profiles;
DROP POLICY IF EXISTS "Admins can update all profiles" ON public.profiles;

-- Enable RLS on profiles
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- Create safer RLS policies
CREATE POLICY "Public profiles are viewable by everyone" 
ON public.profiles FOR SELECT USING (true);

CREATE POLICY "Users can update their own profile" 
ON public.profiles FOR UPDATE USING (auth.uid() = id);

CREATE POLICY "Admins can update all profiles" 
ON public.profiles FOR ALL USING (
  EXISTS (
    SELECT 1 FROM public.profiles
    WHERE id = auth.uid() AND role IN ('admin', 'pastor')
  )
);

-- Create a trigger to create profile on signup
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, email)
  VALUES (new.id, new.email);
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Drop the trigger if it exists
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;

-- Create the trigger
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
          </div>
          
          <div class="actions">
            <button id="fix-profiles">Fix Profiles Table & RLS</button>
          </div>
        </div>
      </div>
      
      <div class="step">
        <div class="step-title"><span class="step-number">3</span> Create Characters Table</div>
        <div class="step-description">Create or update the characters table with the correct schema.</div>
        <div class="step-content">
          <div class="checkbox-container">
            <input type="checkbox" id="show-characters-sql" checked>
            <label for="show-characters-sql">Show SQL Preview</label>
          </div>
          
          <div id="characters-sql-preview" class="sql-preview">
-- Create characters table with the correct schema
CREATE TABLE IF NOT EXISTS public.characters (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  character_name TEXT NOT NULL,
  avatar_url TEXT,
  feature_image_url TEXT,
  short_biography TEXT,
  bible_book TEXT,
  opening_sentence TEXT,
  persona_prompt TEXT,
  scriptural_context TEXT,
  relationships JSONB DEFAULT '{}',
  key_events JSONB DEFAULT '[]',
  character_traits JSONB DEFAULT '[]',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- Create index on character_name for faster searches
CREATE INDEX IF NOT EXISTS idx_character_name ON public.characters (character_name);

-- Enable RLS on characters
ALTER TABLE public.characters ENABLE ROW LEVEL SECURITY;

-- Drop existing RLS policies to avoid conflicts
DROP POLICY IF EXISTS "Characters are viewable by everyone" ON public.characters;
DROP POLICY IF EXISTS "Admins can manage characters" ON public.characters;

-- Create RLS policies for characters
CREATE POLICY "Characters are viewable by everyone" 
ON public.characters FOR SELECT USING (true);

CREATE POLICY "Admins can manage characters" 
ON public.characters FOR ALL USING (
  EXISTS (
    SELECT 1 FROM public.profiles
    WHERE id = auth.uid() AND role IN ('admin', 'pastor')
  )
);
          </div>
          
          <div class="actions">
            <button id="create-characters-table">Create Characters Table</button>
          </div>
        </div>
      </div>
      
      <div class="step">
        <div class="step-title"><span class="step-number">4</span> Create Conversations Table</div>
        <div class="step-description">Create the conversations table to store chat history.</div>
        <div class="step-content">
          <div class="checkbox-container">
            <input type="checkbox" id="show-conversations-sql" checked>
            <label for="show-conversations-sql">Show SQL Preview</label>
          </div>
          
          <div id="conversations-sql-preview" class="sql-preview">
-- Create conversations table
CREATE TABLE IF NOT EXISTS public.conversations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) NOT NULL,
  character_id UUID REFERENCES public.characters(id) NOT NULL,
  title TEXT DEFAULT 'New Conversation',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- Create messages table
CREATE TABLE IF NOT EXISTS public.messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  conversation_id UUID REFERENCES public.conversations(id) NOT NULL,
  role TEXT NOT NULL CHECK (role IN ('user', 'assistant', 'system')),
  content TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- Enable RLS on conversations and messages
ALTER TABLE public.conversations ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.messages ENABLE ROW LEVEL SECURITY;

-- Drop existing RLS policies to avoid conflicts
DROP POLICY IF EXISTS "Users can view their own conversations" ON public.conversations;
DROP POLICY IF EXISTS "Users can manage their own conversations" ON public.conversations;
DROP POLICY IF EXISTS "Users can view messages in their conversations" ON public.messages;
DROP POLICY IF EXISTS "Users can create messages in their conversations" ON public.messages;

-- Create RLS policies for conversations
CREATE POLICY "Users can view their own conversations" 
ON public.conversations FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can manage their own conversations" 
ON public.conversations FOR ALL USING (auth.uid() = user_id);

-- Create RLS policies for messages
CREATE POLICY "Users can view messages in their conversations" 
ON public.messages FOR SELECT USING (
  EXISTS (
    SELECT 1 FROM public.conversations
    WHERE id = conversation_id AND user_id = auth.uid()
  )
);

CREATE POLICY "Users can create messages in their conversations" 
ON public.messages FOR INSERT WITH CHECK (
  EXISTS (
    SELECT 1 FROM public.conversations
    WHERE id = conversation_id AND user_id = auth.uid()
  )
);
          </div>
          
          <div class="actions">
            <button id="create-conversations-table">Create Conversations Tables</button>
          </div>
        </div>
      </div>
      
      <div class="step">
        <div class="step-title"><span class="step-number">5</span> Run All Setup Steps</div>
        <div class="step-description">Run all the database setup steps in sequence.</div>
        <div class="step-content">
          <div class="actions">
            <button id="run-all-setup" class="secondary">Run All Setup Steps</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="tab-content card" id="users">
      <h2>Test Users</h2>
      <div id="users-messages"></div>
      
      <div class="form-group">
        <div class="step-title"><span class="step-number">1</span> Create Test Users</div>
        <div class="step-description">Create test users with different roles for testing.</div>
        
        <div class="checkbox-container">
          <input type="checkbox" id="create-test-user" checked>
          <label for="create-test-user">Regular User: <code>test@example.com / password123</code></label>
        </div>
        
        <div class="checkbox-container">
          <input type="checkbox" id="create-admin-user" checked>
          <label for="create-admin-user">Admin User: <code>testadmin@example.com / password123</code></label>
        </div>
        
        <div class="checkbox-container">
          <input type="checkbox" id="create-pastor-user" checked>
          <label for="create-pastor-user">Pastor User: <code>testpastor@example.com / password123</code></label>
        </div>
      </div>
      
      <div class="form-group">
        <div class="step-title"><span class="step-number">2</span> Custom User</div>
        <div class="step-description">Create a custom user with specified email and role.</div>
        
        <label for="custom-email">Email:</label>
        <input type="email" id="custom-email" placeholder="custom@example.com">
        
        <label for="custom-password">Password:</label>
        <input type="password" id="custom-password" placeholder="Password" value="password123">
        
        <label for="custom-role">Role:</label>
        <select id="custom-role">
          <option value="user">Regular User</option>
          <option value="admin">Admin</option>
          <option value="pastor">Pastor</option>
        </select>
      </div>
      
      <div class="actions">
        <button id="create-test-users">Create Selected Test Users</button>
        <button id="create-custom-user">Create Custom User</button>
        <button id="list-users" class="secondary">List All Users</button>
      </div>
      
      <div class="form-group mt-4">
        <h3>User List</h3>
        <pre id="user-list">No users loaded yet. Click "List All Users" to view.</pre>
      </div>
    </div>
    
    <div class="tab-content card" id="characters">
      <h2>Sample Characters</h2>
      <div id="characters-messages"></div>
      
      <div class="form-group">
        <div class="step-title"><span class="step-number">1</span> Create Sample Characters</div>
        <div class="step-description">Create sample Bible characters for testing.</div>
        
        <div class="checkbox-container">
          <input type="checkbox" id="create-sample-characters" checked>
          <label for="create-sample-characters">Create 5 sample characters</label>
        </div>
      </div>
      
      <div class="form-group">
        <div class="step-title"><span class="step-number">2</span> Custom Character</div>
        <div class="step-description">Create a custom Bible character.</div>
        
        <label for="character-name">Name:</label>
        <input type="text" id="character-name" placeholder="Character Name">
        
        <label for="character-bio">Short Biography:</label>
        <textarea id="character-bio" placeholder="Short biography of the character"></textarea>
        
        <label for="character-book">Bible Book:</label>
        <input type="text" id="character-book" placeholder="Genesis, Exodus, etc.">
        
        <label for="character-avatar">Avatar URL (optional):</label>
        <input type="text" id="character-avatar" placeholder="https://example.com/avatar.jpg">
      </div>
      
      <div class="actions">
        <button id="create-sample-characters-btn">Create Sample Characters</button>
        <button id="create-custom-character">Create Custom Character</button>
        <button id="list-characters" class="secondary">List All Characters</button>
      </div>
      
      <div class="form-group mt-4">
        <h3>Character List</h3>
        <pre id="character-list">No characters loaded yet. Click "List All Characters" to view.</pre>
      </div>
    </div>
    
    <div class="tab-content card" id="debug">
      <h2>Debug Information</h2>
      
      <div class="form-group">
        <h3>Supabase Configuration</h3>
        <pre id="supabase-config"></pre>
      </div>
      
      <div class="form-group">
        <h3>Current Session</h3>
        <pre id="session-info">No active session</pre>
      </div>
      
      <div class="form-group">
        <h3>User Profile</h3>
        <pre id="user-profile">No user profile loaded</pre>
      </div>
      
      <div class="form-group">
        <h3>Custom SQL Query</h3>
        <textarea id="custom-sql" placeholder="SELECT * FROM profiles LIMIT 10;"></textarea>
        <div class="actions">
          <button id="run-custom-sql">Run Query</button>
        </div>
        <pre id="sql-results">Results will appear here</pre>
      </div>
      
      <div class="form-group">
        <h3>Log</h3>
        <pre id="debug-log"></pre>
      </div>
      
      <div class="actions">
        <button id="refresh-session">Refresh Session</button>
        <button id="clear-log">Clear Log</button>
        <button id="test-connection">Test Connection</button>
      </div>
    </div>
    
    <div class="nav-links">
      <a href="/emergency-app.html" class="nav-link">Emergency App</a>
      <a href="/direct-test.html" class="nav-link">Connection Test</a>
      <a href="/" class="nav-link">Main App</a>
    </div>
  </div>

  <script>
    // Initialize Supabase client
    const SUPABASE_URL = 'https://sihfbzltlhkerkxozadt.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNpaGZiemx0bGhrZXJreG96YWR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAwNzc2NTgsImV4cCI6MjA2NTY1MzY1OH0.5H3eQxQxSfHZnpScO9bGHrSXA3GVuorLgpcTCEIomX4';
    
    // Display configuration (without showing full key)
    document.getElementById('supabase-config').textContent = 
      `URL: ${SUPABASE_URL}\nAnon Key: ${SUPABASE_ANON_KEY.substring(0, 10)}...`;
    
    // Initialize Supabase client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Current user state
    let currentUser = null;
    let userProfile = null;
    
    // Debug logging function
    function log(message, type = 'info') {
      const timestamp = new Date().toISOString().substring(11, 19);
      const logElement = document.getElementById('debug-log');
      logElement.textContent = `[${timestamp}] ${message}\n` + logElement.textContent;
      
      console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    // Show message in a specific container
    function showMessage(containerId, message, type = 'info') {
      const container = document.getElementById(containerId);
      const messageElement = document.createElement('div');
      messageElement.className = `message ${type}`;
      messageElement.textContent = message;
      
      // Insert at the top
      if (container.firstChild) {
        container.insertBefore(messageElement, container.firstChild);
      } else {
        container.appendChild(messageElement);
      }
      
      // Auto-remove after 5 seconds for success messages
      if (type === 'success') {
        setTimeout(() => {
          messageElement.remove();
        }, 5000);
      }
    }
    
    // Generate a fallback avatar URL
    function generateAvatarUrl(name) {
      return `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random`;
    }
    
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // Deactivate all tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Activate clicked tab
        tab.classList.add('active');
        const tabId = tab.getAttribute('data-tab');
        document.getElementById(tabId).classList.add('active');
      });
    });
    
    // SQL Preview toggles
    document.getElementById('show-profiles-sql').addEventListener('change', (e) => {
      document.getElementById('profiles-sql-preview').style.display = e.target.checked ? 'block' : 'none';
    });
    
    document.getElementById('show-characters-sql').addEventListener('change', (e) => {
      document.getElementById('characters-sql-preview').style.display = e.target.checked ? 'block' : 'none';
    });
    
    document.getElementById('show-conversations-sql').addEventListener('change', (e) => {
      document.getElementById('conversations-sql-preview').style.display = e.target.checked ? 'block' : 'none';
    });
    
    // Check Authentication
    document.getElementById('check-auth').addEventListener('click', async () => {
      await updateSessionInfo();
      await fetchUserProfile();
      
      const authStatusElement = document.getElementById('auth-status');
      
      if (!currentUser) {
        authStatusElement.className = 'message error';
        authStatusElement.textContent = 'Not authenticated. Please log in.';
        return;
      }
      
      if (!userProfile) {
        authStatusElement.className = 'message warning';
        authStatusElement.textContent = `Authenticated as ${currentUser.email}, but no profile found.`;
        return;
      }
      
      const isAdmin = userProfile.role === 'admin' || userProfile.role === 'pastor';
      
      if (isAdmin) {
        authStatusElement.className = 'message success';
        authStatusElement.textContent = `Authenticated as ${currentUser.email} with ${userProfile.role} privileges.`;
      } else {
        authStatusElement.className = 'message warning';
        authStatusElement.textContent = `Authenticated as ${currentUser.email}, but you don't have admin privileges.`;
      }
    });
    
    // Login button
    document.getElementById('login-button').addEventListener('click', () => {
      // Create login form
      const email = prompt('Enter your email:');
      if (!email) return;
      
      const password = prompt('Enter your password:');
      if (!password) return;
      
      loginUser(email, password);
    });
    
    // Login function
    async function loginUser(email, password) {
      try {
        log(`Attempting login with email: ${email}...`);
        
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password
        });
        
        if (error) {
          showMessage('setup-messages', `Login failed: ${error.message}`, 'error');
          log(`Login failed: ${error.message}`, 'error');
        } else {
          showMessage('setup-messages', 'Login successful!', 'success');
          log('Login successful!', 'success');
          currentUser = data.user;
          await fetchUserProfile();
          await updateSessionInfo();
          document.getElementById('check-auth').click();
        }
      } catch (err) {
        showMessage('setup-messages', `Unexpected error: ${err.message}`, 'error');
        log(`Unexpected error during login: ${err.message}`, 'error');
      }
    }
    
    // Fix Profiles Table & RLS
    document.getElementById('fix-profiles').addEventListener('click', async () => {
      if (!currentUser) {
        showMessage('setup-messages', 'You must be logged in to perform this action', 'error');
        return;
      }
      
      try {
        log('Fixing profiles table and RLS policies...');
        showMessage('setup-messages', 'Fixing profiles table and RLS policies...', 'info');
        
        const sql = document.getElementById('profiles-sql-preview').textContent;
        const { error } = await supabase.rpc('exec_sql', { sql });
        
        if (error) {
          showMessage('setup-messages', `Error fixing profiles: ${error.message}`, 'error');
          log(`Error fixing profiles: ${error.message}`, 'error');
        } else {
          showMessage('setup-messages', 'Profiles table and RLS policies fixed successfully!', 'success');
          log('Profiles table and RLS policies fixed successfully!', 'success');
        }
      } catch (err) {
        showMessage('setup-messages', `Unexpected error: ${err.message}`, 'error');
        log(`Unexpected error fixing profiles: ${err.message}`, 'error');
      }
    });
    
    // Create Characters Table
    document.getElementById('create-characters-table').addEventListener('click', async () => {
      if (!currentUser) {
        showMessage('setup-messages', 'You must be logged in to perform this action', 'error');
        return;
      }
      
      try {
        log('Creating characters table...');
        showMessage('setup-messages', 'Creating characters table...', 'info');
        
        const sql = document.getElementById('characters-sql-preview').textContent;
        const { error } = await supabase.rpc('exec_sql', { sql });
        
        if (error) {
          showMessage('setup-messages', `Error creating characters table: ${error.message}`, 'error');
          log(`Error creating characters table: ${error.message}`, 'error');
        } else {
          showMessage('setup-messages', 'Characters table created successfully!', 'success');
          log('Characters table created successfully!', 'success');
        }
      } catch (err) {
        showMessage('setup-messages', `Unexpected error: ${err.message}`, 'error');
        log(`Unexpected error creating characters table: ${err.message}`, 'error');
      }
    });
    
    // Create Conversations Table
    document.getElementById('create-conversations-table').addEventListener('click', async () => {
      if (!currentUser) {
        showMessage('setup-messages', 'You must be logged in to perform this action', 'error');
        return;
      }
      
      try {
        log('Creating conversations tables...');
        showMessage('setup-messages', 'Creating conversations tables...', 'info');
        
        const sql = document.getElementById('conversations-sql-preview').textContent;
        const { error } = await supabase.rpc('exec_sql', { sql });
        
        if (error) {
          showMessage('setup-messages', `Error creating conversations tables: ${error.message}`, 'error');
          log(`Error creating conversations tables: ${error.message}`, 'error');
        } else {
          showMessage('setup-messages', 'Conversations tables created successfully!', 'success');
          log('Conversations tables created successfully!', 'success');
        }
      } catch (err) {
        showMessage('setup-messages', `Unexpected error: ${err.message}`, 'error');
        log(`Unexpected error creating conversations tables: ${err.message}`, 'error');
      }
    });
    
    // Run All Setup Steps
    document.getElementById('run-all-setup').addEventListener('click', async () => {
      if (!currentUser) {
        showMessage('setup-messages', 'You must be logged in to perform this action', 'error');
        return;
      }
      
      try {
        // Fix profiles
        log('Running all setup steps...');
        showMessage('setup-messages', 'Running all setup steps...', 'info');
        
        log('Step 1: Fixing profiles table and RLS policies...');
        showMessage('setup-messages', 'Step 1: Fixing profiles table and RLS policies...', 'info');
        
        const profilesSql = document.getElementById('profiles-sql-preview').textContent;
        let { error: profilesError } = await supabase.rpc('exec_sql', { sql: profilesSql });
        
        if (profilesError) {
          showMessage('setup-messages', `Error fixing profiles: ${profilesError.message}`, 'error');
          log(`Error fixing profiles: ${profilesError.message}`, 'error');
          return;
        }
        
        // Create characters table
        log('Step 2: Creating characters table...');
        showMessage('setup-messages', 'Step 2: Creating characters table...', 'info');
        
        const charactersSql = document.getElementById('characters-sql-preview').textContent;
        let { error: charactersError } = await supabase.rpc('exec_sql', { sql: charactersSql });
        
        if (charactersError) {
          showMessage('setup-messages', `Error creating characters table: ${charactersError.message}`, 'error');
          log(`Error creating characters table: ${charactersError.message}`, 'error');
          return;
        }
        
        // Create conversations tables
        log('Step 3: Creating conversations tables...');
        showMessage('setup-messages', 'Step 3: Creating conversations tables...', 'info');
        
        const conversationsSql = document.getElementById('conversations-sql-preview').textContent;
        let { error: conversationsError } = await supabase.rpc('exec_sql', { sql: conversationsSql });
        
        if (conversationsError) {
          showMessage('setup-messages', `Error creating conversations tables: ${conversationsError.message}`, 'error');
          log(`Error creating conversations tables: ${conversationsError.message}`, 'error');
          return;
        }
        
        showMessage('setup-messages', 'All setup steps completed successfully!', 'success');
        log('All setup steps completed successfully!', 'success');
      } catch (err) {
        showMessage('setup-messages', `Unexpected error: ${err.message}`, 'error');
        log(`Unexpected error running all setup steps: ${err.message}`, 'error');
      }
    });
    
    // Create Test Users
    document.getElementById('create-test-users').addEventListener('click', async () => {
      if (!currentUser) {
        showMessage('users-messages', 'You must be logged in to perform this action', 'error');
        return;
      }
      
      try {
        log('Creating test users...');
        showMessage('users-messages', 'Creating test users...', 'info');
        
        const createTestUser = document.getElementById('create-test-user').checked;
        const createAdminUser = document.getElementById('create-admin-user').checked;
        const createPastorUser = document.getElementById('create-pastor-user').checked;
        
        if (!createTestUser && !createAdminUser && !createPastorUser) {
          showMessage('users-messages', 'Please select at least one user to create', 'warning');
          return;
        }
        
        let createdCount = 0;
        
        // Create regular test user
        if (createTestUser) {
          const { error } = await createUserWithRole('test@example.com', 'password123', 'user');
          
          if (error) {
            showMessage('users-messages', `Error creating test user: ${error.message}`, 'error');
            log(`Error creating test user: ${error.message}`, 'error');
          } else {
            createdCount++;
            log('Test user created successfully!', 'success');
          }
        }
        
        // Create admin user
        if (createAdminUser) {
          const { error } = await createUserWithRole('testadmin@example.com', 'password123', 'admin');
          
          if (error) {
            showMessage('users-messages', `Error creating admin user: ${error.message}`, 'error');
            log(`Error creating admin user: ${error.message}`, 'error');
          } else {
            createdCount++;
            log('Admin user created successfully!', 'success');
          }
        }
        
        // Create pastor user
        if (createPastorUser) {
          const { error } = await createUserWithRole('testpastor@example.com', 'password123', 'pastor');
          
          if (error) {
            showMessage('users-messages', `Error creating pastor user: ${error.message}`, 'error');
            log(`Error creating pastor user: ${error.message}`, 'error');
          } else {
            createdCount++;
            log('Pastor user created successfully!', 'success');
          }
        }
        
        if (createdCount > 0) {
          showMessage('users-messages', `${createdCount} test users created successfully!`, 'success');
        }
      } catch (err) {
        showMessage('users-messages', `Unexpected error: ${err.message}`, 'error');
        log(`Unexpected error creating test users: ${err.message}`, 'error');
      }
    });
    
    // Create Custom User
    document.getElementById('create-custom-user').addEventListener('click', async () => {
      if (!currentUser) {
        showMessage('users-messages', 'You must be logged in to perform this action', 'error');
        return;
      }
      
      const email = document.getElementById('custom-email').value;
      const password = document.getElementById('custom-password').value;
      const role = document.getElementById('custom-role').value;
      
      if (!email || !password) {
        showMessage('users-messages', 'Email and password are required', 'error');
        return;
      }
      
      try {
        log(`Creating custom user: ${email} with role ${role}...`);
        showMessage('users-messages', `Creating custom user: ${email}...`, 'info');
        
        const { error } = await createUserWithRole(email, password, role);
        
        if (error) {
          showMessage('users-messages', `Error creating custom user: ${error.message}`, 'error');
          log(`Error creating custom user: ${error.message}`, 'error');
        } else {
          showMessage('users-messages', `Custom user ${email} created successfully!`, 'success');
          log(`Custom user ${email} created successfully!`, 'success');
        }
      } catch (err) {
        showMessage('users-messages', `Unexpected error: ${err.message}`, 'error');
        log(`Unexpected error creating custom user: ${err.message}`, 'error');
      }
    });
    
    // Helper function to create a user with a specific role
    async function createUserWithRole(email, password, role) {
      try {
        // First, create the user in auth
        const { data: authData, error: authError } = await supabase.auth.admin.createUser({
          email,
          password,
          email_confirm: true
        });
        
        if (authError) {
          // If the user already exists, try to update their role
          if (authError.message.includes('already exists')) {
            log(`User ${email} already exists, updating role...`);
            
            // Get the user ID
            const { data: userData, error: userError } = await supabase
              .from('profiles')
              .select('id')
              .eq('email', email)
              .single();
            
            if (userError) {
              return { error: userError };
            }
            
            // Update the role
            const { error: updateError } = await supabase
              .from('profiles')
              .update({ role })
              .eq('id', userData.id);
            
            return { error: updateError };
          }
          
          return { error: authError };
        }
        
        const userId = authData.user.id;
        
        // Update the role in the profiles table
        const { error: profileError } = await supabase
          .from('profiles')
          .update({ role })
          .eq('id', userId);
        
        return { error: profileError };
      } catch (err) {
        return { error: err };
      }
    }
    
    // List All Users
    document.getElementById('list-users').addEventListener('click', async () => {
      if (!currentUser) {
        showMessage('users-messages', 'You must be logged in to perform this action', 'error');
        return;
      }
      
      try {
        log('Fetching all users...');
        document.getElementById('user-list').textContent = 'Loading users...';
        
        const { data, error } = await supabase
          .from('profiles')
          .select('*')
          .order('created_at');
        
        if (error) {
          showMessage('users-messages', `Error fetching users: ${error.message}`, 'error');
          log(`Error fetching users: ${error.message}`, 'error');
          document.getElementById('user-list').textContent = `Error: ${error.message}`;
        } else {
          log(`Successfully fetched ${data.length} users`);
          
          // Format the user list for display
          const formattedUsers = data.map(user => ({
            id: user.id,
            email: user.email,
            role: user.role || 'user',
            created_at: user.created_at
          }));
          
          document.getElementById('user-list').textContent = 
            JSON.stringify(formattedUsers, null, 2);
        }
      } catch (err) {
        showMessage('users-messages', `Unexpected error: ${err.message}`, 'error');
        log(`Unexpected error listing users: ${err.message}`, 'error');
        document.getElementById('user-list').textContent = `Error: ${err.message}`;
      }
    });
    
    // Create Sample Characters
    document.getElementById('create-sample-characters-btn').addEventListener('click', async () => {
      if (!currentUser) {
        showMessage('characters-messages', 'You must be logged in to perform this action', 'error');
        return;
      }
      
      if (!document.getElementById('create-sample-characters').checked) {
        showMessage('characters-messages', 'Please check the box to create sample characters', 'warning');
        return;
      }
      
      try {
        log('Creating sample characters...');
        showMessage('characters-messages', 'Creating sample characters...', 'info');
        
        const sampleCharacters = [
          {
            character_name: 'Moses',
            avatar_url: 'https://ui-avatars.com/api/?name=Moses&background=random',
            feature_image_url: null,
            short_biography: 'Moses was a prophet who led the Israelites out of slavery in Egypt and received the Ten Commandments from God on Mount Sinai.',
            bible_book: 'Exodus',
            opening_sentence: 'I was raised in Pharaoh\'s palace, but God called me to lead His people to freedom.',
            persona_prompt: 'You are Moses, the great leader and prophet who led the Israelites out of Egypt. You are humble yet determined, and you have a special relationship with God. You speak with authority but also show compassion for your people.',
            scriptural_context: 'Exodus, Leviticus, Numbers, Deuteronomy',
            relationships: JSON.stringify({
              'Aaron': 'brother',
              'Miriam': 'sister',
              'Pharaoh': 'adoptive family/adversary',
              'Zipporah': 'wife'
            }),
            key_events: JSON.stringify([
              'Found in a basket as a baby',
              'Fled Egypt after killing an Egyptian',
              'Burning bush encounter with God',
              'Confronted Pharaoh with plagues',
              'Parted the Red Sea',
              'Received the Ten Commandments'
            ]),
            character_traits: JSON.stringify([
              'Humble',
              'Faithful',
              'Determined',
              'Initially reluctant speaker',
              'Mediator between God and people'
            ])
          },
          {
            character_name: 'David',
            avatar_url: 'https://ui-avatars.com/api/?name=David&background=random',
            feature_image_url: null,
            short_biography: 'David was a shepherd, musician, warrior, and king of Israel. He was known as a man after God\'s own heart.',
            bible_book: '1 Samuel, 2 Samuel',
            opening_sentence: 'I was the youngest of my brothers, a shepherd boy chosen by God to be king.',
            persona_prompt: 'You are David, the shepherd boy who became king of Israel. You are a skilled musician, a brave warrior, and a passionate worshiper of God. You have experienced great victories and deep failures, but your heart always returns to God.',
            scriptural_context: '1 Samuel, 2 Samuel, Psalms',
            relationships: JSON.stringify({
              'Saul': 'king/mentor/adversary',
              'Jonathan': 'best friend',
              'Bathsheba': 'wife',
              'Solomon': 'son',
              'Nathan': 'prophet/advisor'
            }),
            key_events: JSON.stringify([
              'Anointed by Samuel',
              'Defeated Goliath',
              'Served in Saul\'s court',
              'Fled from Saul',
              'Became king',
              'Sin with Bathsheba',
              'Wrote many Psalms'
            ]),
            character_traits: JSON.stringify([
              'Courageous',
              'Musical',
              'Loyal',
              'Passionate',
              'Repentant'
            ])
          },
          {
            character_name: 'Paul',
            avatar_url: 'https://ui-avatars.com/api/?name=Paul&background=random',
            feature_image_url: null,
            short_biography: 'Paul, formerly known as Saul, was an apostle who spread Christianity throughout the Roman Empire and wrote many books of the New Testament.',
            bible_book: 'Acts, Romans, 1 & 2 Corinthians, and other epistles',
            opening_sentence: 'I once persecuted Christians, but Jesus appeared to me on the road to Damascus and changed my life forever.',
            persona_prompt: 'You are Paul, the apostle to the Gentiles. You are highly educated, passionate about the gospel, and willing to suffer for Christ. You are both theological and practical in your teaching.',
            scriptural_context: 'Acts, Romans, 1 & 2 Corinthians, Galatians, Ephesians, Philippians, Colossians, 1 & 2 Thessalonians, 1 & 2 Timothy, Titus, Philemon',
            relationships: JSON.stringify({
              'Barnabas': 'ministry partner',
              'Timothy': 'spiritual son',
              'Peter': 'fellow apostle',
              'Luke': 'companion and physician',
              'Silas': 'ministry partner'
            }),
            key_events: JSON.stringify([
              'Conversion on the Damascus Road',
              'First missionary journey',
              'Council at Jerusalem',
              'Second and third missionary journeys',
              'Arrest and imprisonment',
              'Shipwreck on Malta',
              'House arrest in Rome'
            ]),
            character_traits: JSON.stringify([
              'Intellectual',
              'Bold',
              'Determined',
              'Adaptable',
              'Self-sacrificing'
            ])
          },
          {
            character_name: 'Mary Magdalene',
            avatar_url: 'https://ui-avatars.com/api/?name=Mary+Magdalene&background=random',
            feature_image_url: null,
            short_biography: 'Mary Magdalene was a follower of Jesus who was delivered from seven demons. She was present at the crucifixion and was the first to see Jesus after his resurrection.',
            bible_book: 'Matthew, Mark, Luke, John',
            opening_sentence: 'Jesus delivered me from seven demons, and I followed him faithfully until the end.',
            persona_prompt: 'You are Mary Magdalene, a devoted follower of Jesus. You have experienced profound healing and transformation through your encounter with Jesus. You are faithful, courageous, and deeply grateful for what Jesus has done in your life.',
            scriptural_context: 'Matthew 27-28, Mark 15-16, Luke 8, Luke 24, John 19-20',
            relationships: JSON.stringify({
              'Jesus': 'teacher/healer',
              'Other women followers': 'companions',
              'Disciples': 'fellow followers'
            }),
            key_events: JSON.stringify([
              'Delivered from seven demons',
              'Supported Jesus\' ministry',
              'Witnessed the crucifixion',
              'Discovered the empty tomb',
              'First to see the risen Jesus'
            ]),
            character_traits: JSON.stringify([
              'Faithful',
              'Courageous',
              'Devoted',
              'Observant',
              'Transformed'
            ])
          },
          {
            character_name: 'Peter',
            avatar_url: 'https://ui-avatars.com/api/?name=Peter&background=random',
            feature_image_url: null,
            short_biography: 'Peter was a fisherman who became one of Jesus\' closest disciples. Despite denying Jesus three times, he became a bold leader in the early church.',
            bible_book: 'Matthew, Mark, Luke, John, Acts, 1 & 2 Peter',
            opening_sentence: 'I was just a simple fisherman when Jesus called me to follow him and become a fisher of men.',
            persona_prompt: 'You are Peter, the impulsive fisherman who became a rock of the early church. You are passionate, sometimes rash, but deeply committed to Jesus. You have experienced both great spiritual insight and devastating failure, which has humbled and matured you.',
            scriptural_context: 'Gospels, Acts, 1 & 2 Peter',
            relationships: JSON.stringify({
              'Jesus': 'teacher/Lord',
              'Andrew': 'brother',
              'James and John': 'fellow disciples and friends',
              'Paul': 'fellow apostle'
            }),
            key_events: JSON.stringify([
              'Called by Jesus while fishing',
              'Walked on water briefly',
              'Confessed Jesus as the Christ',
              'Witnessed the Transfiguration',
              'Denied Jesus three times',
              'Restored by Jesus after resurrection',
              'Preached at Pentecost',
              'Led the early church'
            ]),
            character_traits: JSON.stringify([
              'Impulsive',
              'Bold',
              'Passionate',
              'Natural leader',
              'Humbled by failure'
            ])
          }
        ];
        
        let createdCount = 0;
        
        for (const character of sampleCharacters) {
          const { error } = await supabase
            .from('characters')
            .upsert(character, { onConflict: 'character_name' });
          
          if (error) {
            showMessage('characters-messages', `Error creating character ${character.character_name}: ${error.message}`, 'error');
            log(`Error creating character ${character.character_name}: ${error.message}`, 'error');
          } else {
            createdCount++;
            log(`Character ${character.character_name} created successfully!`, 'success');
          }
        }
        
        if (createdCount > 0) {
          showMessage('characters-messages', `${createdCount} sample characters created successfully!`, 'success');
        }
      } catch (err) {
        showMessage('characters-messages', `Unexpected error: ${err.message}`, 'error');
        log(`Unexpected error creating sample characters: ${err.message}`, 'error');
      }
    });
    
    // Create Custom Character
    document.getElementById('create-custom-character').addEventListener('click', async () => {
      if (!currentUser) {
        showMessage('characters-messages', 'You must be logged in to perform this action', 'error');
        return;
      }
      
      const name = document.getElementById('character-name').value;
      const bio = document.getElementById('character-bio').value;
      const book = document.getElementById('character-book').value;
      const avatar = document.getElementById('character-avatar').value || generateAvatarUrl(name);
      
      if (!name || !bio) {
        showMessage('characters-messages', 'Name and biography are required', 'error');
        return;
      }
      
      try {
        log(`Creating custom character: ${name}...`);
        showMessage('characters-messages', `Creating custom character: ${name}...`, 'info');
        
        const character = {
          character_name: name,
          avatar_url: avatar,
          feature_image_url: null,
          short_biography: bio,
          bible_book: book,
          opening_sentence: `I am ${name}, a character from the Bible.`,
          persona_prompt: `You are ${name}, a character from the Bible. ${bio}`,
          scriptural_context: book,
          relationships: JSON.stringify({}),
          key_events: JSON.stringify([]),
          character_traits: JSON.stringify([])
        };
        
        const { error } = await supabase
          .from('characters')
          .upsert(character, { onConflict: 'character_name' });
        
        if (error) {
          showMessage('characters-messages', `Error creating character: ${error.message}`, 'error');
          log(`Error creating character: ${error.message}`, 'error');
        } else {
          showMessage('characters-messages', `Character ${name} created successfully!`, 'success');
          log(`Character ${name} created successfully!`, 'success');
          
          // Clear the form
          document.getElementById('character-name').value = '';
          document.getElementById('character-bio').value = '';
          document.getElementById('character-book').value = '';
          document.getElementById('character-avatar').value = '';
        }
      } catch (err) {
        showMessage('characters-messages', `Unexpected error: ${err.message}`, 'error');
        log(`Unexpected error creating custom character: ${err.message}`, 'error');
      }
    });
    
    // List All Characters
    document.getElementById('list-characters').addEventListener('click', async () => {
      try {
        log('Fetching all characters...');
        document.getElementById('character-list').textContent = 'Loading characters...';
        
        const { data, error } = await supabase
          .from('characters')
          .select('*')
          .order('character_name');
        
        if (error) {
          showMessage('characters-messages', `Error fetching characters: ${error.message}`, 'error');
          log(`Error fetching characters: ${error.message}`, 'error');
          document.getElementById('character-list').textContent = `Error: ${error.message}`;
        } else {
          log(`Successfully fetched ${data.length} characters`);
          
          // Format the character list for display
          const formattedCharacters = data.map(character => ({
            id: character.id,
            name: character.character_name,
            book: character.bible_book,
            avatar_url: character.avatar_url
          }));
          
          document.getElementById('character-list').textContent = 
            JSON.stringify(formattedCharacters, null, 2);
        }
      } catch (err) {
        showMessage('characters-messages', `Unexpected error: ${err.message}`, 'error');
        log(`Unexpected error listing characters: ${err.message}`, 'error');
        document.getElementById('character-list').textContent = `Error: ${err.message}`;
      }
    });
    
    // Run Custom SQL
    document.getElementById('run-custom-sql').addEventListener('click', async () => {
      if (!currentUser) {
        showMessage('debug-log', 'You must be logged in to perform this action', 'error');
        return;
      }
      
      const sql = document.getElementById('custom-sql').value;
      
      if (!sql) {
        showMessage('debug-log', 'SQL query is required', 'error');
        return;
      }
      
      try {
        log('Running custom SQL query...');
        document.getElementById('sql-results').textContent = 'Running query...';
        
        const { data, error } = await supabase.rpc('exec_sql', { sql });
        
        if (error) {
          log(`Error running SQL query: ${error.message}`, 'error');
          document.getElementById('sql-results').textContent = `Error: ${error.message}`;
        } else {
          log('SQL query executed successfully!', 'success');
          document.getElementById('sql-results').textContent = 
            JSON.stringify(data, null, 2);
        }
      } catch (err) {
        log(`Unexpected error running SQL query: ${err.message}`, 'error');
        document.getElementById('sql-results').textContent = `Error: ${err.message}`;
      }
    });
    
    // Clear log
    document.getElementById('clear-log').addEventListener('click', () => {
      document.getElementById('debug-log').textContent = '';
      log('Log cleared');
    });
    
    // Refresh session
    document.getElementById('refresh-session').addEventListener('click', async () => {
      await updateSessionInfo();
      log('Session info refreshed');
    });
    
    // Test connection
    document.getElementById('test-connection').addEventListener('click', async () => {
      try {
        log('Testing Supabase connection...');
        
        // Simple health check - we expect this to fail with a "relation does not exist" error
        // which actually means the connection is working
        const { data, error } = await supabase.from('_test_connection').select('*').limit(1);
        
        if (error) {
          if (error.code === 'PGRST116' || error.code === '42P01') {
            // These are actually good errors - they mean we connected but the table doesn't exist
            log(' Connection successful! (Table does not exist, but that\'s expected)', 'success');
            showMessage('debug-log', 'Connection successful!', 'success');
          } else {
            log(` Connection error: ${error.message}`, 'error');
            showMessage('debug-log', `Connection error: ${error.message}`, 'error');
          }
        } else {
          log(' Connection successful!', 'success');
          showMessage('debug-log', 'Connection successful!', 'success');
        }
      } catch (err) {
        log(` Unexpected error: ${err.message}`, 'error');
        showMessage('debug-log', `Unexpected error: ${err.message}`, 'error');
      }
    });
    
    // Update session info display
    async function updateSessionInfo() {
      try {
        const { data, error } = await supabase.auth.getSession();
        
        if (error) {
          document.getElementById('session-info').textContent = 
            `Error retrieving session: ${error.message}`;
          log(`Error retrieving session: ${error.message}`, 'error');
        } else {
          document.getElementById('session-info').textContent = 
            JSON.stringify(data, null, 2);
            
          // Update user info if we have a session
          if (data.session) {
            currentUser = data.session.user;
            await fetchUserProfile();
          } else {
            currentUser = null;
            userProfile = null;
            document.getElementById('user-profile').textContent = 'No user profile loaded';
          }
        }
      } catch (err) {
        document.getElementById('session-info').textContent = 
          `Unexpected error: ${err.message}`;
        log(`Unexpected error updating session: ${err.message}`, 'error');
      }
    }
    
    // Fetch user profile from the database
    async function fetchUserProfile() {
      if (!currentUser) return;
      
      try {
        log(`Fetching profile for user: ${currentUser.id}`);
        
        const { data, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', currentUser.id)
          .single();
        
        if (error) {
          log(`Error fetching user profile: ${error.message}`, 'error');
          document.getElementById('user-profile').textContent = 
            `Error: ${error.message}`;
        } else if (data) {
          userProfile = data;
          document.getElementById('user-profile').textContent = 
            JSON.stringify(data, null, 2);
          log(`Successfully fetched user profile. Role: ${data.role || 'user'}`);
        } else {
          log('No profile found for user', 'warning');
          document.getElementById('user-profile').textContent = 'No profile found';
        }
      } catch (err) {
        log(`Unexpected error fetching profile: ${err.message}`, 'error');
        document.getElementById('user-profile').textContent = 
          `Error: ${err.message}`;
      }
    }
    
    // Check if we need to add the exec_sql function
    async function checkAndCreateExecSqlFunction() {
      try {
        // Test if the function exists
        const { error } = await supabase.rpc('exec_sql', { 
          sql: 'SELECT 1 as test' 
        });
        
        // If we get a specific error about the function not existing, create it
        if (error && error.message.includes('function') && error.message.includes('does not exist')) {
          log('Creating exec_sql function...');
          
          // We need to create the function directly via SQL
          // This requires admin privileges
          const createFunctionSql = `
            CREATE OR REPLACE FUNCTION exec_sql(sql text)
            RETURNS JSONB
            LANGUAGE plpgsql
            SECURITY DEFINER
            AS $$
            DECLARE
              result JSONB;
            BEGIN
              EXECUTE sql;
              result := '{"success": true}'::JSONB;
              RETURN result;
            EXCEPTION WHEN OTHERS THEN
              result := jsonb_build_object(
                'success', false,
                'error', SQLERRM,
                'detail', SQLSTATE
              );
              RETURN result;
            END;
            $$;
          `;
          
          // We'll try to create it through the REST API, but this might fail
          // if the user doesn't have the right permissions
          const { error: createError } = await supabase.rpc('exec_sql', { 
            sql: createFunctionSql 
          });
          
          if (createError) {
            log(`Unable to create exec_sql function: ${createError.message}`, 'error');
            showMessage('setup-messages', 'You need to create the exec_sql function in your database. Please contact your database administrator.', 'error');
          } else {
            log('exec_sql function created successfully!', 'success');
          }
        }
      } catch (err) {
        log(`Error checking for exec_sql function: ${err.message}`, 'error');
      }
    }
    
    // Initial setup
    (async function init() {
      log('Initializing database setup tool...', 'info');
      await updateSessionInfo();
      await checkAndCreateExecSqlFunction();
      document.getElementById('check-auth').click();
      log('Initialization complete', 'success');
    })();
  </script>
</body>
</html>
