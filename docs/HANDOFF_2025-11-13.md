 # Bible Character Chat – Comprehensive Handoff (2025‑11‑13)
 
 This document provides the single source of truth for architecture, setup, features, outstanding issues, and validation steps. It is grounded in the actual codebase at `/Users/brian/bible-character-chat`.
 
 ## 1) Repo, Entrypoints, and Docs
 - Repo root: `/Users/brian/bible-character-chat`
 - Key docs already present:
   - `START_HERE.md`, `README.md`, `HANDOFF.md`, `HANDOFF_FINAL.md`
   - `NEXT_SESSION_HANDOFF.md`, `NEXT_DROID_HANDOFF.md`, `PROJECT_HANDOFF.md`
   - `TROUBLESHOOTING.md`, `DEPLOYMENT.md`, `PROJECT_DOCUMENTATION.md`
 - New files (this PR):
   - `docs/INTRO_MESSAGE_2025-11-13.md` (quick intro)
   - `docs/HANDOFF_2025-11-13.md` (this file)
 
 ## 2) Stack Overview
 - Frontend: React 19 + TypeScript, Vite 6, TailwindCSS 3, Framer Motion 12, React Router 7, react‑virtuoso/react‑window for virtualization.
 - Backend/DB: Supabase (PostgreSQL + RLS), Supabase Edge Functions where applicable.
 - AI: OpenAI via server proxy at `/api/openai/chat` (no client key exposure).
 - Payments: Stripe. Client helpers choose Edge Function or Vercel function fallback.
 - Hosting: Vercel (see `vercel.json`).
 
 ## 3) Environment Variables
 Create `.env.local` with these (client) and configure server secrets in hosting:
 
 Client (Vite):
 - `VITE_SUPABASE_URL` – your Supabase URL
 - `VITE_SUPABASE_ANON_KEY` – anon key
 - `VITE_SUPABASE_PROJECT_REF` – project ref (used to derive Edge Function URL)
 - `VITE_OWNER_SLUG` – active organization slug (default fallback is `faithtalkai`)
 - `VITE_FREE_CHARACTER_IDS` – optional CSV
 - `VITE_FREE_MESSAGE_LIMIT` – optional
 - `VITE_FREE_CHARACTER_LIMIT` – optional
 - `VITE_STRIPE_PUBLIC_KEY` – pk_test_…/pk_live_…
 - `VITE_STRIPE_PRICE_MONTHLY`, `VITE_STRIPE_PRICE_YEARLY`
 - `VITE_SUPABASE_EDGE_FUNCTION_URL` – optional explicit Edge Function URL
 
 Server (never in client bundle):
 - `OPENAI_API_KEY` – required by `api/openai/chat.mjs`
 - `STRIPE_SECRET_KEY` – required by `api/create-checkout-session.js`
 
 Where used:
 - Supabase: `src/services/supabase.ts` (env preferred; explicit dev fallbacks exist for local/dev only)
 - OpenAI: `api/openai/chat.mjs` (server proxy)
 - Stripe: `src/services/stripe.ts` (client read of public key + price IDs), `api/create-checkout-session.js` (server secret)
 
 ## 4) Install, Run, Build
 - Install (frozen): `npm ci`
 - Dev: `npm run dev`
 - Build: `npm run build`
 - Preview: `npm run preview`
 - Lint: `npm run lint` (current repo has known lint issues; see PR notes)
 
 Vercel: `vercel.json` rewrites `/api/*`, SPA fallback to `/index.html`, output = `dist`.
 
 ## 5) Data Model & Migrations
 - Migrations: `supabase/migrations/*`.
 - Notable: `20251112_add_premium_gates_to_tier_settings.sql` adds per‑org premium gates:
   - `premium_roundtable_gates` JSONB: `{ allowAllSpeak, strictRotation, followUpsMin, repliesPerRoundMin }`
   - `premium_study_ids` JSONB array of study UUIDs
 
 Core tables (by usage in code): characters, conversations, chat_messages, profiles, character_groups, bible_studies, tier_settings, user_favorites.
 
 ## 6) Key Modules and Paths
 - Premium gating logic:
   - `src/utils/accountTier.js` – load/save settings, `isCharacterFree`, per‑org caching `accountTierSettings:<slug>`
   - `src/services/tierSettingsService.js` – remote (Supabase) sync, `getOwnerSlug()`, cache management
   - Admin UI: `src/components/admin/AccountTierManagement.jsx` – sets free IDs and free names; premium gates and studies per org
 - Character selection and UX:
   - `src/components/ScalableCharacterSelection.tsx`
 - AI proxy and client:
   - Client: `src/services/openai.ts`
   - Server: `api/openai/chat.mjs`
 - Payments:
   - Client: `src/services/stripe.ts`
   - Server fallback: `api/create-checkout-session.js`
 - Supabase Client:
   - `src/services/supabase.ts`
 
 ## 7) Implemented Features
 - Super Admin:
   - Cross‑org user management (SuperadminUsersPage)
   - Owner selector in admin tier UI (when superadmin)
 - Org Admin:
   - Characters CRUD, CSV import/export
   - Visibility toggles
   - Groups, Bible studies management
   - Tier settings: free/premium characters, message limits, roundtable gates, premium studies
   - Featured character per org
 - Users:
   - Character selection with filters/search and virtualization
   - Favorite characters
   - AI chat with conversation persistence
   - Roundtable discussions with defaults/limits/locks
 
 ## 8) Current Priority Issue – Premium Status Mismatch
 Symptom: A character (e.g., Aaron) appears premium on the homepage despite being set as free.
 
 Root causes to verify in code:
 - Owner slug mismatch: cache keys are org‑scoped; ensure `getOwnerSlug()` is consistent.
 - Remote vs. local precedence: enforce remote‐first load on mount; update cache afterward.
 - Name/ID mismatch: guarantee admin saves both `freeCharacters` (IDs) and `freeCharacterNames` to enable robust matching.
 
 Where to fix/confirm:
 - `src/services/tierSettingsService.js` – ensure `getSettings(slug)` always prefers Supabase when available, then caches.
 - `src/utils/accountTier.js` – `loadAccountTierSettings()` merges env defaults with per‑org cache; `isCharacterFree` should check IDs then names.
 - `src/components/ScalableCharacterSelection.tsx` – ensure consumers use `isCharacterFree(character)` and that org changes invalidate stale cache.
 
 Browser diagnostics:
 - `import.meta.env.VITE_OWNER_SLUG`
 - List/clear: `localStorage` keys starting with `accountTierSettings:`
 
 Acceptance:
 - Free/premium status consistent across homepage, chat, and admin for each org.
 - Switching orgs reflects correct gates after reload or explicit reinit.
 
 ## 9) AI & Payments Endpoints
 - OpenAI (server): `api/openai/chat.mjs` – requires `OPENAI_API_KEY`.
 - Stripe checkout:
   - Client picks endpoint: Edge Function URL → derived project ref → `/api/create-checkout-session` fallback
   - Server: `api/create-checkout-session.js` – requires `STRIPE_SECRET_KEY`
 
 ## 10) Testing & Validation
 Immediate tests:
 - Character gating consistent across orgs
 - Admin tier settings persist to Supabase and cache
 - Env precedence in production (no fallback creds used)
 - Cache invalidation when owner slug changes
 
 Regression:
 - CSV import/export
 - Roundtable defaults/limits/locks per org
 - Conversation save/share flows
 - Stripe checkout (test mode) creates session and returns URL; subscription read if Edge Functions deployed
 
 Performance:
 - Virtualized character list smooth for large datasets
 - Image fallbacks and search responsiveness
 
 Security:
 - RLS enforces org boundaries
 - OPENAI/Stripe secrets only on server
 - No secrets committed
 
 ## 11) Roadmap
 - Video/audio “roundtable” with TTS/avatars
 - Deep research tools: scripture X‑refs, history, archaeology, timelines, maps
 - Internationalization: multilingual chat and content, RTL support
 - Automated tests and stronger error boundaries
 
 ## 12) Notes on Lint/Build
 - `npm ci` succeeds.
 - `npm run lint` currently reports repo‑wide errors unrelated to this documentation change. This PR scopes to docs only and does not alter runtime behavior. Follow‑up PRs can address lint/TS issues.
 
 ## 13) Credentials
 No credentials are included. Obtain keys from their respective dashboards and set them in environment variables as listed in Section 3.
 